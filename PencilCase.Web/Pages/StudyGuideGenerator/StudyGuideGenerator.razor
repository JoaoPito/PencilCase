@page "/studyguide"

@using MudBlazor.Utilities;
@using System;
@using System.Globalization;

@inject FragmentApi FragmentApi;
@inject IDialogService DialogService;

<PageTitle>pencilcase</PageTitle>

<div class="pa-4 d-flex flex-column">
<MudGrid Spacing="4">
    <MudItem sm="12" md="4">
        <MudStack Wrap="Wrap.WrapReverse" Spacing="4">
            <SearchBar Label="Choose a topic" OnSubmit="@OnSearchbarSubmit" 
                ClearOnSubmit="false" Disabled="@_isProcessing" MaxLength="@_searchMaxLength" />

            <!-- Sections -->
            <MudCard Elevation="3">
                <MudCardHeader>
                    <MudText Typo="Typo.h5" Align="Align.Start">Sections</MudText>
                </MudCardHeader>
                <MudCardContent Class="pa-0">
                    <div class="rounded-b mud-background-gray pa-2 
                        overflow-y-scroll overflow-x-hidden pa-6"
                        style="height: 75vh;">
                            <MudStack Spacing="4">
                                @if(_items.Where(i => i.Identifier == FragmentGeneratorIdentifier).Count() == 0){
                                    <MudProgressCircular Color="Color.Secondary" Indeterminate="true" />
                                }
                                else
                                {
                                    foreach(var generator in _items
                                        .Where(i => i.Identifier == FragmentGeneratorIdentifier)
                                        .OrderBy(f => f.Order)
                                        .Select(i => i.Generator))
                                    {
                                        <FragmentGeneratorCard 
                                            FragmentGenerator=@generator 
                                            OnAddClicked="OnAddGeneratorClicked"/>
                                    }
                                }
                            </MudStack>
                    </div>
                </MudCardContent>
            </MudCard>

        </MudStack>
    </MudItem>

    <!-- Draft -->
    <MudItem sm="12" md="8">
        <MudCard Elevation="3">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h5" Align="Align.Start">
                        @((_topic == "") ? "Draft" : $"Draft - {FormatTitle(_topic)}")
                        </MudText>
                </CardHeaderContent>
                <CardHeaderActions>
                    <DraftToolbar Disabled="@_isProcessing"
                        OnRenew="OnRegenerateStudyGuide"
                        OnDelete="OnClearStudyGuide" />
                </CardHeaderActions>
            </MudCardHeader>
            <MudCardContent Class="pa-0">
                <div Class="rounded-b mud-background-gray blueprint-dots pa-4
                        overflow-y-scroll overflow-x-hidden pa-8"
                    style="height: 82vh">
                    <MudStack Spacing="5">
                        @if(_items.Where(i => i.Identifier == StudyGuideIdentifier).Count() == 0){
                            <EmptyBlueprintContent />
                        }
                        else
                        {
                            foreach(var fragment in _items
                                .Where(i => i.Identifier == StudyGuideIdentifier)
                                .OrderBy(f => f.Order)
                                .Select(i => i.Fragment))
                            {
                                <FragmentCard Fragment=@fragment
                                    OnRegenerateClicked="@RegenerateFragment"
                                    OnDeleteClicked="@OnDeleteFragment"
                                    OnMoveUpClicked="@OnFragmentMoveUp"
                                    OnMoveDownClicked="@OnFragmentMoveDown"/>
                            }
                        }
                    </MudStack>
            </div>
            </MudCardContent>
        </MudCard>
    </MudItem>
</MudGrid>
</div>

<DownloadButton OnDownload="ExportStudyGuide" />

<style>
    .dialog-background {
        backdrop-filter: blur(20px);
    }
</style>

@code{
    private const String StudyGuideIdentifier = "StudyGuide";
    private const String FragmentGeneratorIdentifier = "Generators";

    private List<FragmentDropItem> _items { get; set; } = new();
    private String _topic = String.Empty;

    private bool _isProcessing { get; set; } = false;
    private int _searchMaxLength { get; set; } = 60;
    
    protected override async Task OnInitializedAsync(){
        List<FragmentGenerator>? generators = new();
            
        try{
            generators = await FragmentApi.GetAllGenerators();
        }
        catch(HttpRequestException err) {
            Console.WriteLine(err.Message);
        }
        if (generators != null) PopulateItemsWithGenerators(generators);
    }

    private StudyGuide FragmentsToStudyGuide(String topic, List<Fragment?>? fragments)
    {
        return new StudyGuide{
            Topic = topic,
            Fragments = (fragments != null) ? fragments : []
        };
    }

    private StudyGuide GetStudyGuideFromDraft()
    {
        var fragments = _items
            .OrderBy(i => i.Order)
            .Where(i => (i.Identifier == StudyGuideIdentifier && i.Fragment != null))
            .Select(i => i.Fragment)
            .ToList();

        return FragmentsToStudyGuide(FormatTitle(_topic), fragments);
    }

    private async Task GenerateFragmentIfDropItemInDraft(FragmentDropItem dropItem)
    {
        if (dropItem.Identifier == StudyGuideIdentifier && dropItem.Fragment == null)
        {
            dropItem.Fragment = await GenerateFragmentWithGenerator(dropItem.Generator);
            this.StateHasChanged();
        }
    }

    private void PopulateItemsWithGenerators(List<FragmentGenerator> generators)
    {
        foreach (var generator in generators)
        {
            _items.Add(new FragmentDropItem()
            {
                Order = 0,
                Identifier = FragmentGeneratorIdentifier,
                Generator = generator
            });
        }
    }

    private async Task<Fragment> GenerateFragmentWithGenerator(FragmentGenerator generator)
    {
        if(_topic == String.Empty || _topic == null){
            return new Fragment{
                Name = generator.Name,
                Content = String.Empty
            };
        }
        return await FragmentApi.GenerateFragment(generator, _topic);
    }

    private async Task GenerateNewStudyGuide(String topic){
        _topic = topic;
        _isProcessing = true;
        foreach(var item in _items.Where(i => i.Identifier == StudyGuideIdentifier)){
            var fragment = await GenerateFragmentWithGenerator(item.Generator);
            item.Fragment = fragment;
        }
        _isProcessing = false;
        this.StateHasChanged();
    }

    private FragmentDropItem GetItemByName(String name){
        var item = _items.FirstOrDefault(i => i.Fragment?.Name == name);
        if(item == null){
            throw new ArgumentException($"Could not find fragment with name '{name}'!");
        }
        return item;
    }

    public async Task RegenerateFragment(String name)
    {
        var item = GetItemByName(name);
        item.Fragment = null;
        this.StateHasChanged();
        var generator = item.Generator;
        item.Fragment = await GenerateFragmentWithGenerator(generator);
        this.StateHasChanged();
    }

    public async Task OnSearchbarSubmit(String topic){
        EraseAllFragments();
        this.StateHasChanged();
        await GenerateNewStudyGuide(topic);
    }

    private void MoveItemToSections(FragmentDropItem item)
    {
        item.Identifier = FragmentGeneratorIdentifier;
        item.Order = 0;
        ReorderFragments();
    }

    public async Task OnDeleteFragment(String name) 
    {
        var item = GetItemByName(name);
        MoveItemToSections(item);
        this.StateHasChanged();
    }

    private async Task ExportStudyGuide()
    {
        var studyGuide = GetStudyGuideFromDraft();

        var options = new DialogOptions { 
            CloseOnEscapeKey = true,
            CloseButton = true,
            BackgroundClass="dialog-background"
        };

        var parameters = new DialogParameters<SGExportDialog> { { x => x.StudyGuide, studyGuide } };
        await DialogService.ShowAsync<SGExportDialog>("Save your Study Guide", parameters, options);
    }

    private void EraseAllFragments(){
        foreach (var item in _items){
            item.Fragment = null;
        }
        this.StateHasChanged();
    }

    public async Task OnRegenerateStudyGuide(){
        EraseAllFragments();
        _isProcessing = true;
        await GenerateNewStudyGuide(_topic);
        _isProcessing = false;
    }

    public async Task OnClearStudyGuide() 
    {
        foreach (var item in _items){
            MoveItemToSections(item);
        }
        this.StateHasChanged();
    }

    public async Task OnAddGeneratorClicked(FragmentGenerator generator)
    {
        var dropItem = _items.FirstOrDefault(i => i.Generator == generator);

        if(dropItem is not null){
            dropItem.Order = _items.Count(x => x.Identifier == StudyGuideIdentifier) + 1;
            dropItem.Identifier = StudyGuideIdentifier;
            GenerateFragmentIfDropItemInDraft(dropItem);
            this.StateHasChanged();
        }
    }

    private string FormatTitle(string input)
    {
        if (string.IsNullOrEmpty(input))
        {
            return input;
        }

        TextInfo textInfo = CultureInfo.CurrentCulture.TextInfo;
        return textInfo.ToTitleCase(input.ToLower());
    }

    public async Task OnFragmentMoveUp(Fragment fragment)
    {
        var item = _items.FirstOrDefault(i => i.Fragment.Name == fragment.Name);
        if(item is null)
            return;

        var itemOnTop = _items
            .Where(i => (i.Identifier == StudyGuideIdentifier && i.Fragment != null))
            .OrderByDescending(i => i.Order)
            .FirstOrDefault(i => i.Order < item.Order);
        if(itemOnTop is null)
            return;

        SwapPositions(item, itemOnTop);
        this.StateHasChanged();
    }

    public async Task OnFragmentMoveDown(Fragment fragment)
    {
        var item = _items.FirstOrDefault(i => i.Fragment.Name == fragment.Name);
        if(item is null)
            return;

        var itemOnTop = _items
            .Where(i => (i.Identifier == StudyGuideIdentifier && i.Fragment != null))
            .OrderBy(i => i.Order)
            .FirstOrDefault(i => i.Order > item.Order);
        if(itemOnTop is null)
            return;

        SwapPositions(item, itemOnTop);
        this.StateHasChanged();
    }

    private void SwapPositions(FragmentDropItem dropItem1, FragmentDropItem dropItem2)
    {
        var oldItem1Order = dropItem1.Order;
        dropItem1.Order = dropItem2.Order;
        dropItem2.Order = oldItem1Order;
    }

    private void ReorderFragments()
    {
        int i = 1;
        foreach(var fragment in _items
            .Where(i => (i.Identifier == StudyGuideIdentifier && i.Fragment != null))
            .OrderBy(i => i.Order))
        {
            fragment.Order = i++;
        }
    }
}